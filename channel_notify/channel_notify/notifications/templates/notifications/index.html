<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç³»ç»Ÿ - é¦–é¡µ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .header .user-info .groups {
            font-size: 12px;
            color: #666;
            background-color: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .connection-status {
            display: inline-flex;
            align-items: center;
            font-size: 12px;
            margin-left: 10px;
        }
        .connection-status .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .connection-status.connected .status-indicator {
            background-color: #4CAF50;
        }
        .connection-status.disconnected .status-indicator {
            background-color: #f44336;
        }
        .header .logout-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .card h2 {
            margin-top: 0;
            font-size: 18px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .notification-form {
            margin-bottom: 20px;
        }
        .notification-form .form-group {
            margin-bottom: 15px;
        }
        
        .notification-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .notification-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        
        .notification-form select:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        .notification-form textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            box-sizing: border-box;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        .notification-form textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        .notification-form button {
            margin-top: 10px;
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .notification-form button:hover {
            background-color: #0b7dda;
        }
        .notification-form button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: #fff;
        }
        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item .content {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.4;
        }
        .notification-item .meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        .notification-item .actions {
            margin-top: 12px;
            text-align: right;
        }
        .notification-item .actions button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        .notification-item .actions button:hover {
            background-color: #45a049;
        }
        .notification-item.pending {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .notification-item.confirmed {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .message.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header .user-info {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }
        }
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
            <h1>å®æ—¶é€šçŸ¥ç³»ç»Ÿ</h1>
            <div class="user-info">
                <span>æ¬¢è¿, {{ user.username }}</span>
                <span class="groups">[{{ groups|join:", " }}]</span>
                <div id="connection-status" class="connection-status disconnected">
                    <span class="status-indicator"></span>
                    <span>æœªè¿æ¥</span>
                </div>
                <a href="{% url 'logout' %}"><button class="logout-btn">é€€å‡ºç™»å½•</button></a>
                <button id="test-websocket" style="margin-left: 10px; padding: 5px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">æµ‹è¯•WebSocket</button>
            </div>
        </div>

    <div class="container">
        <!-- è°ƒè¯•ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="debug-info" style="background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            <h4 style="margin-top: 0;">è°ƒè¯•ä¿¡æ¯:</h4>
            <pre id="debug-output" style="white-space: pre-wrap; word-break: break-all;">ç­‰å¾…WebSocketè¿æ¥å°è¯•...</pre>
        </div>
        
        <!-- å‘é€é€šçŸ¥åŒºåŸŸ -->
        {% if 'operations' in groups %}
        <div class="card">
            <h2>å‘é€é€šçŸ¥</h2>
            <div id="message-area"></div>
            <div class="notification-form">
                <div class="form-group">
                    <label for="target-group">ç›®æ ‡ç»„ï¼š</label>
                    <select id="target-group">
                        <option value="finance">è´¢åŠ¡ç»„</option>
                        <option value="hr">äººäº‹ç»„</option>
                        <option value="it">ITç»„</option>
                        <option value="management">ç®¡ç†å±‚</option>
                    </select>
                </div>
                <textarea id="notification-content" placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹..." required></textarea>
                <button id="send-notification">å‘é€é€šçŸ¥</button>
            </div>
        </div>
        {% endif %}

        <!-- æ¥æ”¶é€šçŸ¥åŒºåŸŸ -->
        {% if 'finance' in groups %}
        <div class="card">
            <h2>å¾…ç¡®è®¤é€šçŸ¥</h2>
            <div class="notification-list" id="pending-notifications">
                <!-- å¾…ç¡®è®¤é€šçŸ¥å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
        {% endif %}

        <!-- å·²å‘é€é€šçŸ¥å†å² -->
        <div class="card">
            <h2>å·²å‘é€é€šçŸ¥</h2>
            <div class="notification-list" id="sent-notifications">
                <!-- å·²å‘é€é€šçŸ¥å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- å·²æ¥æ”¶é€šçŸ¥å†å² -->
        <div class="card">
            <h2>å·²æ¥æ”¶é€šçŸ¥</h2>
            <div class="notification-list" id="received-notifications">
                <!-- å·²æ¥æ”¶é€šçŸ¥å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·ç»„æ•°æ® - æ”¾ç½®åœ¨scriptæ ‡ç­¾å¤–éƒ¨ -->
     {{ groups|json_script:"user-groups" }}
    
    <script>
        // ç”¨æˆ·ä¿¡æ¯
        const userInfo = {
            username: '{{ user.username }}',
            groups: []
        };
        
        // ä»DOMä¸­æå–ç”¨æˆ·ç»„æ•°æ®
        const groupsElement = document.getElementById('user-groups');
        if (groupsElement) {
            try {
                    userInfo.groups = JSON.parse(groupsElement.textContent);
                    logDebug('æˆåŠŸè§£æç”¨æˆ·ç»„æ•°æ®: ' + JSON.stringify(userInfo.groups));
                    logDebug('ç”¨æˆ·ç»„æ•°æ®ç±»å‹: ' + (Array.isArray(userInfo.groups) ? 'æ•°ç»„' : typeof userInfo.groups));
                } catch (e) {
                    logDebug('é”™è¯¯: è§£æç”¨æˆ·ç»„æ•°æ®å¤±è´¥: ' + e);
                    logDebug('åŸå§‹ç”¨æˆ·ç»„æ•°æ®: ' + groupsElement.textContent);
                    userInfo.groups = [];
                }
            }
        
        // è°ƒè¯•ä¿¡æ¯è¾“å‡ºå‡½æ•°
        function logDebug(message) {
            const debugOutput = document.getElementById('debug-output');
            if (debugOutput) {
                const timestamp = new Date().toLocaleTimeString();
                debugOutput.textContent += `[${timestamp}] ${message}\n`;
                debugOutput.scrollTop = debugOutput.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            }
            console.log(message);
        }
        
        logDebug('åˆå§‹åŒ–åçš„ç”¨æˆ·ä¿¡æ¯: ' + JSON.stringify(userInfo));
        
        // WebSocketè¿æ¥ç®¡ç†
        let sockets = {};
        let isConnected = false;
        
        // è·å–WebSocketå…³é—­ä»£ç å«ä¹‰çš„è¾…åŠ©å‡½æ•°
        function getCloseCodeMeaning(code) {
            const codeMeanings = {
                1000: 'æ­£å¸¸å…³é—­',
                1001: 'ç»ˆç«¯æ­£åœ¨ç¦»å¼€',
                1002: 'åè®®é”™è¯¯',
                1003: 'æ”¶åˆ°äº†æ— æ³•æ¥å—çš„æ•°æ®ç±»å‹',
                1004: 'ä¿ç•™',
                1005: 'æ— çŠ¶æ€ç ',
                1006: 'æ„å¤–å…³é—­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨å´©æºƒ',
                1007: 'æ•°æ®æ ¼å¼é”™è¯¯',
                1008: 'æ¶ˆæ¯å†…å®¹ä¸ç¬¦åˆç­–ç•¥',
                1009: 'æ¶ˆæ¯è¿‡å¤§',
                1010: 'éœ€è¦æ‰©å±•',
                1011: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
                1012: 'æœåŠ¡é‡å¯',
                1013: 'æš‚æ—¶ä¸­æ–­',
                1014: 'TLSæ¡æ‰‹å¤±è´¥',
                1015: 'TLSæ¡æ‰‹å¤±è´¥ï¼ˆä¿ç•™ï¼‰'
            };
            return codeMeanings[code] || `æœªçŸ¥ä»£ç  (${code})`;
        } // è¿æ¥çŠ¶æ€æ ‡å¿—

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                if (status) {
                    statusElement.classList.remove('disconnected');
                    statusElement.classList.add('connected');
                    statusElement.querySelector('span:last-child').textContent = 'å·²è¿æ¥';
                } else {
                    statusElement.classList.remove('connected');
                    statusElement.classList.add('disconnected');
                    statusElement.querySelector('span:last-child').textContent = 'æœªè¿æ¥';
                }
            }
            
            // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            const sendButton = document.getElementById('send-notification');
            if (sendButton) {
                sendButton.disabled = !status;
            }
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            logDebug('å¼€å§‹åˆå§‹åŒ–WebSocketè¿æ¥...');
            logDebug('å½“å‰ç”¨æˆ·ç»„æ•°é‡: ' + userInfo.groups.length);
            logDebug('ç”¨æˆ·ç»„åˆ—è¡¨: ' + JSON.stringify(userInfo.groups));
            // é‡ç½®è¿æ¥çŠ¶æ€
            sockets = {};
            isConnected = false;
            updateConnectionStatus(false);
            
            // ä¸ºæ¯ä¸ªç”¨æˆ·ç»„åˆ›å»ºä¸€ä¸ªWebSocketè¿æ¥
            userInfo.groups.forEach((group, index) => {
                try {
                    // ä½¿ç”¨wss://è€Œä¸æ˜¯ws://å¦‚æœç½‘ç«™ä½¿ç”¨HTTPS
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${wsProtocol}//${window.location.host}/ws/notifications/${group}/`;
                    
                    // åˆ›å»ºWebSocketè¿æ¥
                    const socket = new WebSocket(wsUrl);
                    sockets[group] = socket;
                    logDebug(`WebSocketå¯¹è±¡åˆ›å»ºæˆåŠŸ (${group})`);
                    
                    socket.onopen = function(e) {
                        logDebug(`âœ… WebSocketè¿æ¥å·²æ‰“å¼€ (${group})`);
                        logDebug(`è¿æ¥å‚æ•°: ` + JSON.stringify(e));
                        isConnected = true;
                        updateConnectionStatus(true);
                    };
                    
                    socket.onmessage = function(event) {
                        logDebug(`ğŸ“© æ”¶åˆ°WebSocketæ¶ˆæ¯ (${group})`);
                        try {
                            const data = JSON.parse(event.data);
                            logDebug(`è§£æåçš„æ¶ˆæ¯æ•°æ®: ` + JSON.stringify(data));
                            handleWebSocketMessage(data);
                        } catch (parseError) {
                            logDebug(`âŒ è§£æWebSocketæ¶ˆæ¯å¤±è´¥: ${parseError}, åŸå§‹æ¶ˆæ¯: ${event.data}`);
                        }
                    };
                    
                    socket.onclose = function(event) {
                        logDebug(`âŒ WebSocketè¿æ¥å·²å…³é—­ (${group}): ${event.code} - ${event.reason}`);
                        logDebug(`å…³é—­äº‹ä»¶è¯¦æƒ…: ` + JSON.stringify(event));
                        logDebug(`å…³é—­ä»£ç å«ä¹‰: ${getCloseCodeMeaning(event.code)}`);
                        
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è¿æ¥éƒ½å·²å…³é—­
                        const allClosed = Object.values(sockets).every(s => s.readyState === WebSocket.CLOSED);
                        logDebug(`æ‰€æœ‰è¿æ¥éƒ½å·²å…³é—­: ${allClosed}`);
                        if (allClosed) {
                            isConnected = false;
                            updateConnectionStatus(false);
                            
                            // å°è¯•é‡æ–°è¿æ¥
                            showMessage(`WebSocketè¿æ¥å·²æ–­å¼€ï¼Œå°†åœ¨5ç§’åå°è¯•é‡æ–°è¿æ¥`, 'error');
                            logDebug(`â±ï¸  å°†åœ¨5ç§’åå°è¯•é‡æ–°è¿æ¥...`);
                            setTimeout(reconnectWebSocket, 5000);
                        }
                    };
                    
                    socket.onerror = function(error) {
                        logDebug(`âŒ WebSocketé”™è¯¯ (${group}): ` + JSON.stringify(error));
                        logDebug(`é”™è¯¯å¯¹è±¡: ` + JSON.stringify(error));
                    };
                } catch (error) {
                    logDebug(`âŒ åˆ›å»ºWebSocketè¿æ¥å¤±è´¥ (${group}): ` + JSON.stringify(error));
                    logDebug(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error)}`);
                    showMessage(`è¿æ¥åˆ°é€šçŸ¥æœåŠ¡å™¨å¤±è´¥`, 'error');
                }
            });
            
            if (userInfo.groups.length === 0) {
                logDebug('âš ï¸ æ²¡æœ‰å¯ç”¨çš„ç”¨æˆ·ç»„ï¼Œæ— æ³•å»ºç«‹WebSocketè¿æ¥');
            }
        }

        // é‡æ–°è¿æ¥WebSocket
        function reconnectWebSocket() {
            logDebug('å°è¯•é‡æ–°è¿æ¥WebSocket...');
            initWebSocket();
        }

        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            const messageArea = document.getElementById('message-area');
            
            if (data.type === 'notification_message') {
                // æ”¶åˆ°æ–°é€šçŸ¥
                showMessage('æ”¶åˆ°æ–°é€šçŸ¥!', 'info');
                addNotificationToReceivedList(data.message);
                
                // å¦‚æœæ˜¯è´¢åŠ¡ç»„ç”¨æˆ·ï¼Œæ·»åŠ åˆ°å¾…ç¡®è®¤åˆ—è¡¨
                if (userInfo.groups.includes('finance')) {
                    addNotificationToPendingList(data.message);
                }
            } else if (data.type === 'notification_confirmed') {
                // é€šçŸ¥å·²è¢«ç¡®è®¤
                showMessage(`é€šçŸ¥ #${data.message.id} å·²è¢« ${data.message.confirmed_by} ç¡®è®¤`, 'success');
                updateNotificationStatus(data.message);
            } else if (data.type === 'notification_sent') {
                // é€šçŸ¥å‘é€æˆåŠŸ
                showMessage('é€šçŸ¥å‘é€æˆåŠŸ!', 'success');
                loadNotifications(); // é‡æ–°åŠ è½½é€šçŸ¥åˆ—è¡¨
            } else if (data.type === 'error') {
                // é”™è¯¯æ¶ˆæ¯
                showMessage(data.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.textContent = text;
            
            messageArea.appendChild(messageElement);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageElement.remove();
            }, 3000);
        }

        // å‘é€é€šçŸ¥
        function sendNotification() {
            const content = document.getElementById('notification-content').value.trim();
            const targetGroup = document.getElementById('target-group') ? document.getElementById('target-group').value : 'finance';
            
            if (!content) {
                showMessage('è¯·è¾“å…¥é€šçŸ¥å†…å®¹', 'error');
                return;
            }
            
            if (!isConnected || Object.keys(sockets).length === 0) {
                showMessage('WebSocketè¿æ¥æœªå»ºç«‹ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè¿æ¥æ˜¯æ‰“å¼€çŠ¶æ€
            const openSockets = Object.values(sockets).filter(s => s.readyState === WebSocket.OPEN);
            if (openSockets.length === 0) {
                showMessage('WebSocketè¿æ¥å·²å…³é—­ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // å‡†å¤‡æ¶ˆæ¯æ•°æ®
            const data = {
                type: 'send_notification',
                content: content,
                receiver_group: targetGroup
            };
            
            // é€šè¿‡ç¬¬ä¸€ä¸ªæ‰“å¼€çš„è¿æ¥å‘é€æ¶ˆæ¯
            openSockets[0].send(JSON.stringify(data));
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('notification-content').value = '';
            showMessage('é€šçŸ¥å·²å‘é€', 'success');
            
            // æ»šåŠ¨é€šçŸ¥åˆ—è¡¨åˆ°åº•éƒ¨
            setTimeout(() => {
                const notificationsList = document.getElementById('notifications-list');
                if (notificationsList) {
                    notificationsList.scrollTop = notificationsList.scrollHeight;
                }
            }, 100);
        }

        // ç¡®è®¤é€šçŸ¥
        function confirmNotification(notificationId) {
            if (!isConnected || Object.keys(sockets).length === 0) {
                showMessage('WebSocketè¿æ¥æœªå»ºç«‹ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè¿æ¥æ˜¯æ‰“å¼€çŠ¶æ€
            const openSockets = Object.values(sockets).filter(s => s.readyState === WebSocket.OPEN);
            if (openSockets.length === 0) {
                showMessage('WebSocketè¿æ¥å·²å…³é—­ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                return;
            }
            
            // é€šè¿‡ç¬¬ä¸€ä¸ªæ‰“å¼€çš„è¿æ¥å‘é€ç¡®è®¤æ¶ˆæ¯
            openSockets[0].send(JSON.stringify({
                type: 'confirm_notification',
                notification_id: notificationId
            }));
            
            showMessage('é€šçŸ¥ç¡®è®¤è¯·æ±‚å·²å‘é€', 'success');
        }

        // æ·»åŠ é€šçŸ¥åˆ°å¾…ç¡®è®¤åˆ—è¡¨
        function addNotificationToPendingList(notification) {
            const pendingList = document.getElementById('pending-notifications');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé€šçŸ¥ï¼Œæ¸…ç©º"åŠ è½½ä¸­"æ–‡æœ¬
            if (pendingList.querySelector('p')) {
                pendingList.innerHTML = '';
            }
            
            const notificationItem = createNotificationElement(notification, true);
            pendingList.insertBefore(notificationItem, pendingList.firstChild);
        }

        // æ·»åŠ é€šçŸ¥åˆ°å·²æ¥æ”¶åˆ—è¡¨
        function addNotificationToReceivedList(notification) {
            const receivedList = document.getElementById('received-notifications');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé€šçŸ¥ï¼Œæ¸…ç©º"åŠ è½½ä¸­"æ–‡æœ¬
            if (receivedList.querySelector('p')) {
                receivedList.innerHTML = '';
            }
            
            const notificationItem = createNotificationElement(notification, false);
            receivedList.insertBefore(notificationItem, receivedList.firstChild);
        }

        // æ›´æ–°é€šçŸ¥çŠ¶æ€
        function updateNotificationStatus(data) {
            // æ›´æ–°å·²å‘é€é€šçŸ¥åˆ—è¡¨ä¸­çš„çŠ¶æ€
            const sentList = document.getElementById('sent-notifications');
            const sentItem = sentList.querySelector(`[data-id="${data.id}"]`);
            if (sentItem) {
                sentItem.classList.remove('pending');
                sentItem.classList.add('confirmed');
                sentItem.querySelector('.meta').textContent += ` | å·²ç”± ${data.confirmed_by} ç¡®è®¤äº ${formatDateTime(data.confirmed_at)}`;
                
                // æ·»åŠ è§†è§‰åé¦ˆåŠ¨ç”»
                sentItem.style.backgroundColor = '#f0f8ff';
                setTimeout(() => {
                    sentItem.style.backgroundColor = '';
                }, 500);
            }
            
            // ä»å¾…ç¡®è®¤åˆ—è¡¨ä¸­ç§»é™¤
            const pendingList = document.getElementById('pending-notifications');
            if (pendingList) {
                const pendingItem = pendingList.querySelector(`[data-id="${data.id}"]`);
                if (pendingItem) {
                    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»æ•ˆæœ
                    pendingItem.style.transition = 'opacity 0.3s, transform 0.3s';
                    pendingItem.style.opacity = '0';
                    pendingItem.style.transform = 'translateX(-20px)';
                    
                    setTimeout(() => {
                        pendingItem.remove();
                    }, 300);
                }
            }
            
            // æ›´æ–°å·²æ¥æ”¶é€šçŸ¥åˆ—è¡¨ä¸­çš„çŠ¶æ€
            const receivedList = document.getElementById('received-notifications');
            const receivedItem = receivedList.querySelector(`[data-id="${data.id}"]`);
            if (receivedItem) {
                receivedItem.classList.remove('pending');
                receivedItem.classList.add('confirmed');
                
                // æ›´æ–°å·²æ¥æ”¶åˆ—è¡¨ä¸­çš„çŠ¶æ€æ˜¾ç¤º
                const actionsDiv = receivedItem.querySelector('.actions');
                if (actionsDiv) {
                    actionsDiv.innerHTML = `<span class="status confirmed">å·²ç¡®è®¤</span>`;
                }
                
                // æ·»åŠ è§†è§‰åé¦ˆåŠ¨ç”»
                receivedItem.style.backgroundColor = '#f0f8ff';
                setTimeout(() => {
                    receivedItem.style.backgroundColor = '';
                }, 500);
            }
        }

        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        function createNotificationElement(notification, showConfirmButton = false) {
            const item = document.createElement('div');
            item.className = `notification-item ${notification.status}`;
            item.setAttribute('data-id', notification.id);
            
            let contentHtml = `<div class="content">${notification.content}</div>`;
            
            let metaHtml = '<div class="meta">';
            if (notification.sender) {
                metaHtml += `å‘é€è€…: ${notification.sender} | `;
            }
            if (notification.sender_group) {
                metaHtml += `å‘é€ç»„: ${notification.sender_group} | `;
            }
            metaHtml += `æ—¶é—´: ${formatDateTime(notification.created_at)}`;
            
            if (notification.status === 'confirmed') {
                metaHtml += ` | å·²ç¡®è®¤`;
                if (notification.confirmed_by) {
                    metaHtml += ` by ${notification.confirmed_by}`;
                }
            }
            metaHtml += '</div>';
            
            let actionsHtml = '';
            if (showConfirmButton && notification.status === 'pending') {
                actionsHtml = `<div class="actions">
                    <button onclick="confirmNotification(${notification.id})">ç¡®è®¤é€šçŸ¥</button>
                </div>`;
            }
            
            item.innerHTML = contentHtml + metaHtml + actionsHtml;
            return item;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // åŠ è½½é€šçŸ¥æ•°æ®
        function loadNotifications() {
            fetch('/api/notifications/')
                .then(response => response.json())
                .then(data => {
                    // åŠ è½½å·²å‘é€é€šçŸ¥
                    const sentList = document.getElementById('sent-notifications');
                    sentList.innerHTML = '';
                    
                    if (data.sent_notifications && data.sent_notifications.length > 0) {
                        data.sent_notifications.forEach(notification => {
                            const notificationItem = createNotificationElement(notification);
                            sentList.appendChild(notificationItem);
                        });
                    } else {
                        sentList.innerHTML = '<p>æš‚æ— å·²å‘é€é€šçŸ¥</p>';
                    }
                    
                    // åŠ è½½å·²æ¥æ”¶é€šçŸ¥
                    const receivedList = document.getElementById('received-notifications');
                    receivedList.innerHTML = '';
                    
                    if (data.received_notifications && data.received_notifications.length > 0) {
                        data.received_notifications.forEach(notification => {
                            const notificationItem = createNotificationElement(notification, false);
                            receivedList.appendChild(notificationItem);
                        });
                    } else {
                        receivedList.innerHTML = '<p>æš‚æ— å·²æ¥æ”¶é€šçŸ¥</p>';
                    }
                    
                    // åŠ è½½å¾…ç¡®è®¤é€šçŸ¥ï¼ˆä»…è´¢åŠ¡ç»„ç”¨æˆ·ï¼‰
                    if (userInfo.groups.includes('finance')) {
                        const pendingList = document.getElementById('pending-notifications');
                        pendingList.innerHTML = '';
                        
                        const pendingNotifications = data.received_notifications.filter(
                            notification => notification.status === 'pending'
                        );
                        
                        if (pendingNotifications.length > 0) {
                            pendingNotifications.forEach(notification => {
                                const notificationItem = createNotificationElement(notification, true);
                                pendingList.appendChild(notificationItem);
                            });
                        } else {
                            pendingList.innerHTML = '<p>æš‚æ— å¾…ç¡®è®¤é€šçŸ¥</p>';
                        }
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½é€šçŸ¥å¤±è´¥:', error);
                    showMessage('åŠ è½½é€šçŸ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ æµ‹è¯•WebSocketæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const testBtn = document.getElementById('test-websocket');
            if (testBtn) {
                testBtn.addEventListener('click', function() {
                    console.log('======= æ‰‹åŠ¨æµ‹è¯•WebSocketè¿æ¥ =======');
                    // é‡æ–°åˆå§‹åŒ–WebSocketè¿æ¥
                    initWebSocket();
                });
            }
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initWebSocket();
            
            // åŠ è½½é€šçŸ¥æ•°æ®
            loadNotifications();
            
            // ç»‘å®šå‘é€é€šçŸ¥æŒ‰é’®äº‹ä»¶
            const sendButton = document.getElementById('send-notification');
            if (sendButton) {
                sendButton.addEventListener('click', sendNotification);
            }
        });
    </script>
</body>
</html>